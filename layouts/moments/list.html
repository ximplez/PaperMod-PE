{{- define "main" }}
{{- $paginator := .Paginate .Pages }}

{{ $css := resources.Get "css/pe/moments.css" | minify | fingerprint }}
<link crossorigin="anonymous" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}" rel="preload stylesheet" as="style">

{{ $dateformat := .Params.DateFormat }}

<article class="post-single">
    <header class="page-header">
    </header>

    <div class="post-content">
        <div class="pe-moments">
            <ul>
                {{- range $moment := $paginator.Pages }}
                {{- if .Content }}
                <li class="pe-moment">
                    <div class="pe-moment-header">
                        <img src="{{ site.Params.label.icon }}" alt="{{ site.Params.author }}" class="pe-moment-profile">
                    </div>
                    <div class="pe-moment-body">
                        {{ if .Params.expired }}
                        <div class="pe-stamp">
                            <svg class="pe-stamp-icon" viewBox="0 0 1300 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M784.074702 99.196443l10.927871 18.473304-21.302843-2.56935-14.180213 16.066571-4.130475-21.042655-19.676671-8.521137 18.733492-10.440019 2.016452-21.335366 15.708814 14.603017 20.945085-4.683373-9.041512 19.449008zM1067.22363 642.402668l-18.440781 10.92787 2.56935-21.302842-16.099094-14.180213 21.042655-4.130475 8.521137-19.676671 10.440019 18.733492 21.367889 2.016452-14.603017 15.708814 4.683373 20.945085-19.481531-9.041512z" fill="#DBDBDB" p-id="1981"></path><path d="M1067.22363 642.402668l-18.440781 10.92787 2.56935-21.302842-16.099094-14.180213 21.042655-4.130475 8.521137-19.676671 10.440019 18.733492 21.367889 2.016452-14.603017 15.708814 4.683373 20.945085-19.481531-9.041512zM571.924408 100.009528l-17.400031-12.488994 20.52228-6.211974 6.504685-20.457234 12.261331 17.595172 21.432936-0.09757-12.944323 17.074798 6.732349 20.359663-20.262093-7.02506-17.269938 12.716659 0.422804-21.46546zM991.444053 784.43246l-21.172749 3.480006 10.114785-18.928632-9.822074-19.026203 21.107702 3.772717 15.090868-15.253486 2.927109 21.237796 19.156296 9.626933-19.318914 9.366746-3.219819 21.205273-14.863204-15.48115zM428.008258 156.795426l-20.749945-5.333841 16.879657-13.237034-1.365983-21.400413 17.822836 11.936097 19.936859-7.870669-5.88674 20.619851 13.692361 16.521899-21.432936 0.813086-11.513292 18.083024-7.382817-20.132zM854.260251 896.475655l-20.749945-5.333841 16.879657-13.237034-1.365983-21.400413 17.822836 11.96862 19.936859-7.903192-5.854217 20.619851 13.659838 16.554423-21.432936 0.780562-11.513292 18.115547-7.382817-20.164523zM562.460092 923.665237l10.895347 18.440782-21.302843-2.569351-14.180212 16.099095-4.130475-21.042655-19.676672-8.521137 18.733493-10.440019 2.016452-21.36789 15.708814 14.603018 20.945085-4.683373-9.008989 19.48153zM242.787359 420.788058l-18.473305 10.895347 2.569351-21.302843-16.066572-14.180213 21.042656-4.130474 8.521137-19.676672 10.440019 18.733492 21.335366 2.016453-14.603018 15.708813 4.683374 20.945085-19.449008-9.008988z" fill="#DBDBDB" p-id="1982"></path><path d="M242.787359 420.788058l-18.473305 10.895347 2.569351-21.302843-16.066572-14.180213 21.042656-4.130474 8.521137-19.676672 10.440019 18.733492 21.335366 2.016453-14.603018 15.708813 4.683374 20.945085-19.449008-9.008988zM700.814737 943.959854l-17.400032-12.521518 20.522281-6.211974 6.504685-20.42471 12.26133 17.595172 21.432937-0.130094-12.944323 17.107321 6.732349 20.359663-20.262093-7.025059-17.269938 12.684135 0.422804-21.432936zM303.541115 278.823313l-21.140226 3.480006 10.114785-18.928633-9.854597-19.058726 21.107702 3.772717 15.090868-15.220962 2.927109 21.237796 19.156296 9.626933-19.28639 9.366746-3.252342 21.172749-14.863205-15.448626z" fill="#DBDBDB" p-id="1983"></path><path d="M407.648595 90.642782a486.713038 486.713038 0 0 1 504.568397 11.578339l25.010513-14.407877A512.081309 512.081309 0 0 0 139.850723 547.401747l24.977989-14.407877a486.778085 486.778085 0 0 1 242.819883-442.351088zM893.28836 933.422265a486.810608 486.810608 0 0 1-504.568398-11.610863l-25.010513 14.407877a512.081309 512.081309 0 0 0 797.5394-459.621026l-24.97799 14.505447a486.843132 486.843132 0 0 1-242.982499 442.318565z" fill="#DBDBDB" p-id="1984"></path><path d="M814.061299 795.880705a326.665269 326.665269 0 0 1-258.170939 29.563792l-29.791456 17.172368a353.236906 353.236906 0 0 0 472.793013-272.448721l-29.693886 17.172367a326.762839 326.762839 0 0 1-155.136732 208.540194zM486.875655 228.119295a326.795363 326.795363 0 0 1 258.170939-29.563792l29.791456-17.172368a353.236906 353.236906 0 0 0-472.793013 272.448721l29.82398-17.172367a326.762839 326.762839 0 0 1 155.006638-208.540194zM1288.350389 374.73489a53.923837 53.923837 0 0 1-14.34283 12.001143L229.420232 988.712085A53.793743 53.793743 0 0 1 156.112434 968.937843l-148.924757-258.235985a53.76122 53.76122 0 0 1 19.741718-73.437891L1071.516722 35.352962A53.826266 53.826266 0 0 1 1144.82452 55.062157l148.827187 258.268508a53.793743 53.793743 0 0 1-5.398888 61.404225zM32.19819 665.754486a28.360426 28.360426 0 0 0-5.626553 10.73273 28.067715 28.067715 0 0 0 2.699444 21.432936L178.195839 956.188661a28.165285 28.165285 0 0 0 38.442687 10.342449l1044.587328-601.976052a28.132762 28.132762 0 0 0 10.440019-38.442687l-148.924758-258.268509a28.197808 28.197808 0 0 0-38.442687-10.342449L39.711101 659.444942a28.230332 28.230332 0 0 0-7.512911 6.309544z" fill="#DBDBDB" p-id="1985"></path><path d="M497.608385 599.406702l-136.59838 78.836779 38.149976 66.087597q7.903192 13.659838 21.302843 5.88674l112.75871-65.046848a20.814991 20.814991 0 0 0 9.757027-10.960394q2.56935-9.757027-16.71704-46.73616l18.213118-4.065428q20.262093 42.703256 17.920406 55.452438a35.775766 35.775766 0 0 1-15.936477 19.18882l-121.572559 70.185549q-24.912943 14.375353-39.906241-11.610862L318.079085 640.483786l15.838908-9.139082 18.310687 31.710338 120.336669-69.567604-33.173893-57.501413-148.111672 85.601652-8.878895-15.416103 164.308338-94.870828zM552.08512 448.823249a354.50532 354.50532 0 0 1 4.715896 35.157821l44.524568-25.693504-22.246022-38.735398 16.261712-9.39927L617.619819 448.823249l73.763125-42.573162 8.911418 15.416103-73.763125 42.605685 8.26095 14.310307a271.603113 271.603113 0 0 1 14.277783 31.385104l91.065587-52.52533 8.781324 15.220963-81.926505 47.289058q43.744005 38.149976 127.94715 24.782849l-0.780562 18.961156q-89.95979 10.537589-138.582309-32.523424a133.671272 133.671272 0 0 1 3.90281 47.972051q-5.463935 43.353724-47.776909 90.122407l-16.261712-8.45609q41.955217-47.419152 46.541019-86.219597a127.361728 127.361728 0 0 0-3.740193-38.052406L556.150548 583.827982l-8.748801-15.220963 85.178847-49.20794a229.77799 229.77799 0 0 0-14.082643-31.515198l-8.260949-14.310306-52.655423 30.539495a170.878069 170.878069 0 0 1-7.057583 47.809433l-20.164523-3.935335q14.407877-43.22363 3.675147-96.366904zM835.071431 438.318183a243.925679 243.925679 0 0 0-5.724123-39.873717l16.944704-2.17907a239.3724 239.3724 0 0 1 6.894966 46.54102q22.766397 5.691599 42.605685 12.716658l-4.000381 19.026203q-15.936478-5.756646-38.345117-12.488994a174.943497 174.943497 0 0 1-23.514435 79.32463l-17.822836-8.488613a160.210386 160.210386 0 0 0 23.156677-75.909671 410.445609 410.445609 0 0 0-42.475591-8.943942l3.252342-16.977227c11.936097 1.658695 24.847896 4.065428 39.028109 7.252723z m-51.647197-62.997872a268.903668 268.903668 0 0 1-2.634398 71.551533l-18.115547-1.853835a236.510338 236.510338 0 0 0 3.252343-68.787042z m-0.487852-42.573162L824.338701 308.972527l8.781324 15.188439-101.993457 58.867397-8.748801-15.188439L767.552803 341.49595a221.809751 221.809751 0 0 0-23.872193-15.87143l14.993298-12.163761q12.131237 9.171606 24.262474 19.28639z m15.57872 35.775767l4.228046-15.058346a255.666635 255.666635 0 0 1 48.785135 14.017596l-4.130475 16.294235a331.251072 331.251072 0 0 0-48.882706-15.383579z m78.251358-4.358139a237.09576 237.09576 0 0 1-0.325234 28.945847l-17.139844-6.244497q2.114023-50.313737-25.303224-116.0761l17.400032-6.504685q7.2202 18.148071 13.30208 37.824742l61.794505-35.775766 8.911418 15.448626-18.700968 10.797777q28.392949 53.76122 28.620613 103.554582a163.495252 163.495252 0 0 0 72.364618 20.489757l-1.23589 19.221343a168.243672 168.243672 0 0 1-71.90929-20.782468 198.588026 198.588026 0 0 1-26.636685 78.511545l-17.00975-9.171605q24.392568-39.028109 27.026965-79.357154a341.691091 341.691091 0 0 1-51.159346-41.012038z m-7.31777-44.231857l2.146546 9.334223c0.748039 3.675147 1.300937 6.504685 1.658694 9.008988a312.680197 312.680197 0 0 0 54.444212 46.996348 207.597014 207.597014 0 0 0-25.433317-84.268191z" fill="#AFAFAF" p-id="1986"></path></svg>
                        </div>
                        {{ end }}
                        <div class="pe-moment-content">
                            {{ .Content }}
                        </div>
                        {{ if .Params.tags }}
                        <div class="pe-moment-tags">
                            {{- range $index, $tag := (.Params.tags) }}
                            <span class="pe-moment-tag">{{ $tag }}</span>
                            {{- end }}
                        </div>
                        {{ end }}
                        <div class="pe-moment-bottom">
                            <div class="pe-moment-time">
                                <span>{{ $moment.Param "date" | time.Format (default site.Params.DateFormat $dateformat) }}</span>
                            </div>
                            {{ if not (.Param "hideComment") }}
                            <button class="pe-moment-comment-btn" onclick="showComment(this)" data-slug="{{ $moment.Param "slug" }}">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M281.535354 387.361616c-31.806061 0-57.664646 26.763636-57.664647 59.733333 0 32.969697 25.858586 59.733333 57.664647 59.733334s57.664646-26.763636 57.664646-59.733334c0-33.09899-25.858586-59.733333-57.664646-59.733333z m230.529292 0c-31.806061 0-57.664646 26.763636-57.664646 59.733333 0 32.969697 25.729293 59.733333 57.664646 59.733334 31.806061 0 57.535354-26.763636 57.535354-59.733334 0-33.09899-25.858586-59.733333-57.535354-59.733333z m230.4 0c-31.806061 0-57.664646 26.763636-57.664646 59.733333 0 32.969697 25.858586 59.733333 57.664646 59.733334s57.664646-26.763636 57.664647-59.733334c-0.129293-33.09899-25.858586-59.733333-57.664647-59.733333z m115.2-270.222222H166.335354c-63.612121 0-115.2 53.527273-115.2 119.59596v390.981818c0 65.939394 52.751515 126.836364 117.785858 126.836363h175.579798c30.513131 32.581818 157.220202 149.979798 157.220202 149.979798 5.559596 5.818182 14.739394 5.818182 20.29899 0 0 0 92.832323-91.410101 153.212121-149.979798h179.717172c65.034343 0 117.785859-60.89697 117.785859-126.836363V236.606061c0.129293-65.939394-51.458586-119.466667-115.070708-119.466667z m57.535354 510.577778c0 32.969697-27.668687 67.620202-60.250505 67.620202H678.335354c-21.462626 0-40.727273 21.979798-40.727273 21.979798l-124.121212 114.941414-124.121212-114.941414s-23.660606-21.979798-43.830303-21.979798H168.921212c-32.581818 0-60.250505-34.650505-60.250505-67.620202V236.606061c0-32.969697 25.729293-59.733333 57.664647-59.733334h691.329292c31.806061 0 57.535354 26.763636 57.535354 59.733334v391.111111z m0 0"></path></svg>
                            </button>
                            {{ end }}
                        </div>
                    </div>
                </li>
                {{ end }}
                {{ end }}
            </ul>
        </div>
    </div>

</article>

{{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer">
    <nav class="pagination">
        {{- if $paginator.HasPrev }}
        <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
            {{ i18n "prev_page" }}
            {{- if (.Param "ShowPageNums") }}
            {{- sub $paginator.PageNumber 1 }}/{{ $paginator.TotalPages }}
            {{- end }}
        </a>
        {{- end }}
        {{- if $paginator.HasNext }}
        <a class="next" href="{{ $paginator.Next.URL | absURL }}">
            {{- i18n "next_page" }}
            {{- if (.Param "ShowPageNums") }}
            {{- add 1 $paginator.PageNumber }}/{{ $paginator.TotalPages }}
            {{- end }}
        </a>
        {{- end }}
    </nav>
</footer>
{{- end }}

<script>
    const getStoredTheme = () => localStorage.getItem("pref-theme") === "dark" ? "{{ .Site.Params.giscus.darkTheme }}" : "{{ .Site.Params.giscus.lightTheme }}";
    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
        }
        sendMessage({setConfig: {theme: getStoredTheme()}})
    }
    function showComment(element) {
        const slug = element.getAttribute('data-slug');
        const commentElement = document.getElementById(slug);
        if (commentElement) {
            commentElement.remove();
            return;
        }
        const comments = document.getElementsByClassName("pe-moment-comment");
        if (comments) {
            for (let comment of comments) {
                comment.remove();
            }
        }
        const momentBody = element.closest('.pe-moment-body');
        let giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "{{ .Site.Params.giscus.repo }}",
            "data-repo-id": "{{ .Site.Params.giscus.repoId }}",
            "data-category": "{{ .Site.Params.giscus.category }}",
            "data-category-id": "{{ .Site.Params.giscus.categoryId }}",
            "data-mapping": "{{ .Site.Params.giscus.mapping | default "pathname" }}",
            "data-term": "moments/" + slug,
            "data-strict": "{{ .Site.Params.giscus.strict | default "0" }}",
            "data-reactions-enabled": "{{ .Site.Params.giscus.reactionsEnabled | default "1" }}",
            "data-emit-metadata": "{{ .Site.Params.giscus.emitMetadata | default "0" }}",
            "data-input-position": "{{ .Site.Params.giscus.inputPosition | default "bottom" }}",
            "data-theme": getStoredTheme(),
            "data-lang": "{{ .Site.Params.giscus.lang | default "en" }}",
            "crossorigin": "anonymous",
            "async": "",
        };
        const commentDiv = document.createElement('div');
        commentDiv.id = slug;
        commentDiv.className = "pe-moment-comment";
        // 动态创建 giscus script
        let giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
            ([key, value]) => giscusScript.setAttribute(key, value));
        commentDiv.appendChild(giscusScript);
        momentBody.appendChild(commentDiv);
    }
    document.addEventListener("DOMContentLoaded", () => {
        // 页面主题变更后，变更 giscus 主题
        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", setGiscusTheme);
        }
        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");
        if (themeFloatSwitcher) {
            themeFloatSwitcher.addEventListener("click", setGiscusTheme);
        }
    });
</script>
{{- end }}{{/* end main */}}
